INSERT INTO `apmena-oneconsumer-dna-apac-qa.space_crm_1_2.dim_consumer_napac`
(
consumer_code,
market_code,
signature_code,
division,
MARS_PERSON_ID,
LUCID,
YEAR_OF_BIRTH,
gender,
consumer_type,
is_consumer_flag,
is_valid_direct_message,
is_opt_in_direct_message,
is_valid_email,
is_opt_in_email,
is_valid_home_phone,
is_opt_in_home_phone,
is_valid_mobile,
is_opt_in_call,
is_opt_in_sms,
is_valid_line,
is_opt_in_line,
is_whatsapp_contactable,
is_we_chat_contactable,
load_ts
)
(select
CONCAT(M.market_code,C.ROW_WID) as CONSUMER_CODE,
M.market_code,
--H.compass_signature_code as signature_code,
cast(s.signature_code as string ) as signature_code,
S.division,
CASE 
	WHEN M.market_code='JP' THEN C.MARS_PERSON_ID
	WHEN M.market_code in ('TW','HK','KR') THEN C.X_LUCID   --- check condition
	ELSE 'NA'
END AS MARS_PERSON_ID,
CASE
	WHEN M.market_code='JP' THEN concat(M.market_code,C.MARS_PERSON_ID)
	WHEN M.market_code in ('TW','HK','KR') THEN concat(M.market_code,C.X_LUCID) --- check condition
	ELSE 'NA'
END AS LUCID,
SUBSTR(C.BIRTH_DT, 1,4) as YEAR_OF_BIRTH,
C.SEX_MF_CD as gender,    -- Added Gender from W_PERSON_D_2
--FL.LAST_TR_DT as last_transaction_date, -- check we need ?
CASE 
	WHEN M.market_code='TW' AND C.MARS_PERSON_ID in ('01996099999','07994099999','16993099999','40995099999','45997099999','51992099999','57991099999','01996099997','07994099997','16993099997','40995099997','45997099997','51992099997','57991099997') THEN 'Tourist'
	WHEN M.market_code='HK' AND Y.TAG_VALUE = 'High Spenders' then 'HS'
	WHEN M.market_code='HK' AND Y.TAG_VALUE = 'Extended Local' then 'Extended Locals'
    when M.market_code='HK' and D.ATTRIB_09 in ('Tourist','Tour','Touris', NULL,' Ztourist') then 'Tourist'
    when M.market_code='HK' and D.ATTRIB_09 in  ('Local','LOCAL','Zlocal') then 'Local'
--	WHEN M.market_code='HK' AND Y.TAG_VALUE not in ('Extended Local','High Spenders') then D.ATTRIB_09
	WHEN M.market_code='JP' AND C.Mars_Person_ID in ('01000000005','15000000004','16000000004','40000000005','45000000005','51000000004','402A0000656','401A0003274','402M0000004','403P0000003','401K0000681','40140000026','40250000001','40260000005','40340000002','40300000001','403Q0000048','401X0000002','40330000006','40320000250','40150000029','40200000004','40130000001','401Y0000001','401F0000008','402U0000051','40C30000768','40360000034','402C0000075','401B0000015','401N0000001','401T0000003','40110000230','401C0000175','45CK0002150','45BY0023963','401N0009214') THEN 'Tourist'
	WHEN M.market_code='KR' AND C.X_LUCID in ('C10000006848086','C10000004427215','C10000003563465','C10000003563472','C10000003563328','C10000003563499','C10000003563504','C10000004427247','C10000006848202','C10000006384784','C10000002139446','C10000006848048','C10000003563368','C10000003563562','C10000004427238','C10000003563694','C10000006384782','C10000003563556','C10000006998195','C10000006998116','C10000004427302','C10000003563396','C10000004589418','C10000006848213','C10000006848263','C10000004427191','C10000006848040','C10000003563719','C10000003563384','C10000004427311','C10000004758517','C10000003563367','C10000004427232','C10000004427252','C10000006848126','C10000003563516','C10000003563535','C10000002277041','C10000006848229','C10000003563762','C10000002146433','C10000002139450','C10000003563392','C10000006848004','C10000006848081','C10000003563726','C10000003525966','C10000006848066','C10000006848099','C10000003563341','C10000003563330','C10000002139408','C10000003563348','C10000003563746','C10000004427374','C10000003563426','C10000004427246','C10000003563586','C10000006384758','C10000006848253','C10000002139419','C10000004427330','C10000003563416','C10000007000033','C10000003563666','C10000003563636','C10000006848063','C10000006384774','C10000003563552','C10000004758509','C10000004427341','C10000003563620','C10000006848225','C10000004427345','C10000006996224','C10000006696212','C10000006848157','C10000006848064','C10000002155247','C10000003552040','C10000006384790','C10000006848226','C10000002139440','C10000003563550','C10000003563543','C10000002139444','C10000006848093','C10000004427233','C10000003563744','C10000003563534','C10000003563498','C10000003563329','C10000003563502','C10000003563477','C10000002277050','C10000004427258','C10000004427274','C10000004427390','C10000004427342','C10000004427296','C10000006848076','C10000006847995','C10000004427728','C10000002139407','C10000006384773','C10000003563705','C10000006848075','C10000003563383','C10000006384796','C10000002139425','C10000003563429','C10000006998127','C10000006848149','C10000006384771','C10000003563628','C10000004427329','C10000004427288','C10000006848185','C10000004427256','C10000006384792','C10000003563757','C10000003563753','C10000003563374','C10000003563349','C10000006848208','C10000003563682','C10000003563569','C10000003563444','C10000003563696','C10000003563747','C10000003563509','C10000006384788','C10000003201445','C10000002139406','C10000004427226','C10000003563357','C10000006848201','C10000002139431','C10000003563455','C10000002277044','C10000004427264','C10000003563768','C10000006848050','C10000003563622','C10000003563625','C10000004398163','C10000003563500','C10000003563669','C10000003563501','C10000003563342','C10000003563491','C10000003563475','C10000003563503','C10000002277023','C10000006384765','C10000006848214','C10000003563621','C10000003563424','C10000006848264','C10000003563727','C10000006384760','C10000006384791','C10000006384767','C10000003563414','C10000006848243','C10000003563411','C10000006999911','C10000006998117','C10000006384781','C10000003563714','C10000004427358','C10000003563582','C10000003563551','C10000006384795','C10000003563593','C10000004427248','C10000002139399','C10000004171770','C10000006696208','C10000003563745','C10000006848252','C10000003563632','C10000002139426','C10000006384766','C10000006384794','C10000004427263','C10000004427325','C10000006848150','C10000006848065','C10000003563436','C10000003563598','C10000004427307','C10000003551047','C10000003563748','C10000002277029','C10000004427273','C10000002139436','C10000006848087','C10000006848266','C10000003563464','C10000003563463','C10000003591170','C10000006848151','C10000006847994','C10000004427261','C10000006699781','C10000004428026','C10000004399830','C10000003563713','C10000003551946','C10000005092707','C10000003563359','C10000004427279','C10000006848172','C10000003776492','C10000006384776','C10000003563763','C10000004427324','C10000003563410','C10000003563460','C10000006384769','C10000003563488','C10000007000823','C10000006384780','C10000002935720','C10000006848282','C10000006695829','C10000004427349','C10000006848197','C10000006848096','C10000003563611','C10000006848183','C10000003563378','C10000003563490','C10000002277052','C10000003563608','C10000004478099','C10000003563737','C10000004427216','C10000003563683','C10000003563476','C10000003563402','C10000003563425','C10000003563642','C10000006848273','C10000006384789','C10000006384778','C10000004427290','C10000002143255','C10000006384777','C10000003563555','C10000002239962','C10000006848176','C10000002277040','C10000003563358','C10000004427197','C10000006848174','C10000004427343','C10000002139445','C10000003563668','C10000003552044','C10000003563372','C10000003551947','C10000003563515','C10000004522579','C10000003563729','C10000006848173','C10000003563667','C10000006695832','C10000002139432','C10000002277042','C10000004427386','C10000006384797','C10000006848281','C10000004427326','C10000006384772','C10000003563703','C10000004427359','C10000006848244','C10000002139414','C10000003563522','C10000006848220','C10000006848142','C10000004399827','C10000003563594','C10000007006416','C10000007001797','C10000006999440','C10000006998144','C10000003563764','C10000002277039','C10000003563532','C10000003563712','C10000003563718','C10000006856784','C10000003563574','C10000002140334','C10000003563769','C10000004427303','C10000006847996','C10000006384770','C10000006848054','C10000004478095','C10000003563388','C10000006848092','C10000003563612','C10000003563533','C10000003563523','C10000006384768','C10000006696209','C10000006384787','C10000003563435','C10000006848049','C10000004427214','C10000006848184','C10000004427382','C10000006848274','C10000003563583','C10000003563401','C10000004427360','C10000004427383','C10000006848129','C10000006848265','C10000003563687','C10000003563544','C10000006848000','C10000003563570','C10000003563704','C10000004522577','C10000003563507') THEN 'Tourist'
	ELSE 'Local'
END AS consumer_type,
CASE 
	When D.X_CUSTOMER_FLG='Y' OR D.X_CUSTOMER_FLG is null THEN 'Y'
ELSE 'N'
END AS is_consumer_flag,

CASE 
	WHEN M.market_code='JP' AND C.ST_ADDRESS IS NOT NULL AND (C.X_INVALID_ADDRESS_FLG='N' OR C.X_INVALID_ADDRESS_FLG IS NULL) THEN 'Y'
	WHEN M.market_code in ('KR','HK','TW') THEN 'NA' 
	ELSE 'N'
END AS is_valid_direct_message,
CASE 
	WHEN M.market_code='JP' AND C.X_ADDR_PERM_JPN='Opt-in' THEN 'Y' 
	WHEN M.market_code in ('KR','HK','TW') THEN 'NA'
	ELSE 'N' 
END AS is_Opt_In_direct_message,
CASE 
	WHEN M.market_code='JP' AND C.EMAIL_ADDR IS NOT NULL AND ( C.X_INVALID_EMAIL_FLG='N' OR C.X_INVALID_EMAIL_FLG IS NULL) THEN 'Y' 
	WHEN M.market_code='KR' AND C.X_INVALID_EMAIL_FLG='N' THEN 'Y'
	WHEN M.market_code='HK' AND D.ATTRIB_07='Y' THEN 'Y'
	WHEN M.market_code='TW' AND D.ATTRIB_07='Y' THEN 'Y'
	ELSE 'N'
END AS is_Valid_email,
CASE 
	WHEN M.market_code='JP' AND D.X_EMAIL_PERM_STATUS='Opt-in' THEN 'Y'
	WHEN M.market_code='KR' AND cast(C.SUPPRESS_EMAIL_FLG as string)='N' THEN 'Y'
	WHEN M.market_code='HK' AND D.X_EMAIL_PERM_STATUS  in ('ENS','PAR')  THEN 'Y'
	WHEN M.market_code='TW' AND D.X_EMAIL_PERM_STATUS in ('ENS','PAR','Unspecified','unspecified')  THEN 'Y' --2408change
	ELSE 'N'
END AS is_Opt_In_email,
CASE 
	WHEN M.market_code='JP' AND C.X_INVALID_HOME_PH_NUM_FLG='N' THEN 'Y' --not found N&Y getting e.g REF etc
	WHEN M.market_code='KR' AND C.X_INVALID_HOME_PH_NUM_FLG='N' THEN 'Y'  --not found N&Y
	WHEN M.market_code='TW' AND D.X_TM_QUALITY='Y' THEN 'Y'
	ELSE 'N'
END AS is_Valid_home_phone,
CASE 
	WHEN M.market_code='JP' AND D.X_HP_CELL_PERM_STATUS='Opt-in' THEN 'Y'
	WHEN M.market_code='KR' AND C.SUPPRESS_CALL_FLG is false THEN 'Y'
	WHEN M.market_code='TW' AND D.X_HP_CELL_PERM_STATUS in ('ENS','PAR','Unspecified','unspecified')  THEN 'Y'
	ELSE 'N' 
END AS is_Opt_In_home_Phone,
CASE 
	WHEN M.market_code='JP' AND C.X_INVALID_CELL_PH_NUM_FLG='N' THEN 'Y' 
	WHEN M.market_code='KR' AND C.X_INVALID_CELL_PH_NUM_FLG='N' THEN 'Y'
	WHEN M.market_code='HK' AND D.X_SMS_QUALITY='Y' THEN 'Y'
	WHEN M.market_code='TW' AND D.X_SMS_QUALITY='Y' THEN 'Y'
	ELSE 'N'
END AS is_Valid_mobile,
CASE 
	WHEN M.market_code='JP' AND C.X_MOBILE_PERM_STATUS='Opt-in' THEN 'Y' --not found 'Opt-in'
	WHEN M.market_code='KR' AND C.X_MOBILE_PERM_STATUS='1' THEN 'Y' --not found 1
	WHEN M.market_code='HK' AND C.X_MOBILE_PERM_STATUS  in ('ENS','PAR')  THEN 'Y' --not found ('ENS','PAR')
	WHEN M.market_code='TW' AND C.X_MOBILE_PERM_STATUS in ('ENS','PAR','Unspecified')  THEN 'Y'  --not found ('ENS','PAR','Unspecified')
	ELSE 'N'
END AS is_Opt_In_Call,	
CASE 
	WHEN M.market_code='JP' AND D.X_SMS_PERM_STATUS='Opt-in' THEN 'Y'
	WHEN M.market_code='KR' AND D.X_SUPPRESS_SMS_FLG='Y' THEN 'N'
	WHEN M.market_code='KR' AND D.X_SUPPRESS_SMS_FLG<>'Y' THEN 'Y'
	WHEN M.market_code='HK' AND D.X_SMS_PERM_STATUS  in ('ENS','PAR')  THEN 'Y'
	WHEN M.market_code='TW' AND D.X_SMS_PERM_STATUS in ('ENS','PAR','Unspecified')  THEN 'Y'
	ELSE 'N' 
END AS is_Opt_In_SMS,
CASE 
	WHEN M.market_code='JP' AND C.LINE_ID IS NOT NULL THEN 'Y'
	WHEN M.market_code='TW' AND C.SOCIAL_NETWORK_ID is not null AND C.SOCIAL_NETWORK_ID<>'N' THEN 'Y'
	ELSE 'N'
END AS is_Valid_Line,	
CASE 
	WHEN M.market_code='JP' AND D.X_OPT_OUT_LINE <>'Opt-out' THEN 'Y' 
	WHEN M.market_code='TW' AND C.SOCIAL_NETWORK_ID is not null and C.SOCIAL_NETWORK_ID<>'N' THEN 'Y'
	ELSE 'N' 
END AS is_Opt_In_Line,
CASE 
	WHEN M.market_code='HK' AND D.X_HP_CELL_PERM_STATUS  in ('ENS','PAR')  THEN 'Y'
	WHEN M.market_code in ('JP','KR','TW') THEN 'NA' 
	ELSE 'N'
END AS is_whatsapp_contactable,
"NA" AS is_we_chat_contactable,
D.LOAD_TIME as load_ts
FROM 

`apmena-oneconsumer-dna-apac-qa.crm_market_summary_parallel_run.W_PERSON_D_2` C 
INNER JOIN 	
`apmena-oneconsumer-dna-apac-qa.crm_market_summary_parallel_run.W_PERSON_DX` D	on C.row_wid=cast(D.row_wid as string) and C.VIS_PR_BU_ID =D.X_VIS_PR_BU_ID 
LEFT JOIN 
(
	select row_wid ,TAG_VALUE from
	(
		select C.row_wid, TAG_VALUE, ROW_number() OVER( PARTITION BY CONTACT_WID order by YN.TAG_VALUE desc) as rnk 
		from
		`apmena-oneconsumer-dna-apac-qa.crm_market_summary_parallel_run.W_PERSON_D_2` C
		inner join
		`apmena-oneconsumer-dna-apac-qa.crm_market_summary_parallel_run.WC_CUST_TAG_F` X on C.row_wid= cast(X.contact_wid as string)
		inner join
		`apmena-oneconsumer-dna-apac-qa.crm_market_summary_parallel_run.W_TAG_D` YN on X.tagging_wid = YN.row_wid and YN.TAG_VALUE in ('High Spenders','Extended Local')
		INNER JOIN
		`apmena-oneconsumer-dna-apac-qa.crm_market_summary_parallel_run.W_INT_ORG_D` b on C.VIS_PR_BU_ID = b.INTEGRATION_ID
		inner join `apmena-onedata-dna-apac-dv.crossdomain.dim_market` M on lower(ltrim(rtrim(b.PAR_ORG_NAME)))=lower(ltrim(rtrim(M.market_name)))
		 where M.market_code='HK'
	) where rnk=1
) as Y on C.row_wid=Y.row_wid
INNER JOIN 
`apmena-oneconsumer-dna-apac-qa.crm_market_summary_parallel_run.W_INT_ORG_D` b on C.VIS_PR_BU_ID = b.INTEGRATION_ID
INNER JOIN
`apmena-onedata-dna-apac-dv.crossdomain.dim_market`	M on lower(ltrim(rtrim(b.PAR_ORG_NAME)))=lower(ltrim(rtrim(M.market_name)))
LEFT JOIN 
`apmena-oneconsumer-dna-apac-qa.crm_market_summary_parallel_run.WC_CONTACT_ORDER_FL` FL ON C.ROW_WID=cast(FL.CONTACT_WID as string)
--LEFT JOIN 
--`apmena-oneconsumer-dna-apac-qa.crm_market_summary_parallel_run.WC_PRODUCT_DH` p on a.PROD_WID=p.PROD_WID (for sig)
--LEFT JOIN
--`apmena-onedata-dna-apac-dv.product.dim_sap_product`J on p.sapcode=J.sap_product_code
--LEFT JOIN 
--`apmena-onedata-dna-apac-dv.product.dim_compass_product` H on J.sap_orig_reference_code=H.sap_reference_code
--INNER JOIN 
--`apmena-oneconsumer-dna-apac-dv.crm_market_summary_data.counter_to_channel` z on z.counter_id=a.PR_OWNER_ORG_WID
LEFT JOIN
`apmena-oneconsumer-dna-apac-qa.space_crm_domain.signature` S on C.VIS_PR_BU_ID=S.integration_id)